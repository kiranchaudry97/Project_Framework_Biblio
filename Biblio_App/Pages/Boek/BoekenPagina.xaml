<?xml version="1.0" encoding="utf-8" ?>
<?xaml-comp compile="true" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:Biblio_App.ViewModels"
             xmlns:models="clr-namespace:Biblio_Models.Entiteiten;assembly=Biblio_Models"
             x:Class="Biblio_App.Pages.BoekenPagina"
             x:DataType="viewmodel:BoekenViewModel"
             Title="{Binding PageTitle}"
             x:Name="Page">

    <Shell.TitleView>
        <Grid Padding="0,0,8,0" VerticalOptions="Center">
            <Label Text="{Binding PageTitle}" FontSize="22" FontAttributes="Bold" VerticalOptions="Center" TextColor="{StaticResource White}" />
        </Grid>
    </Shell.TitleView>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="12">
            <!-- main content unchanged -->
            <Frame Style="{StaticResource WelcomeCardStyle}">
                <VerticalStackLayout Spacing="12">

                    <!-- Search/filter row -->
                    <VerticalStackLayout Spacing="8">
                        <HorizontalStackLayout Spacing="8">
                            <SearchBar Placeholder="{Binding SearchPlaceholder}" Text="{Binding SearchText}" HorizontalOptions="FillAndExpand" />
                            <Button Text="{Binding SearchButtonText}" Command="{Binding ZoekCommand}" />
                        </HorizontalStackLayout>
                        <HorizontalStackLayout Spacing="8">
                            <Picker Title="{Binding CategoryTitle}" ItemsSource="{Binding Categorien}" ItemDisplayBinding="{Binding Naam}" SelectedItem="{Binding SelectedFilterCategorie}" WidthRequest="200" HorizontalTextAlignment="Start" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>

                    <!-- spacer -->
                    <HorizontalStackLayout HorizontalOptions="FillAndExpand">
                        <Label Text="" HorizontalOptions="FillAndExpand" />
                    </HorizontalStackLayout>

                    <!-- List of books (Titel, Auteur, Acties) -->
                    <CollectionView ItemsSource="{Binding Boeken}" SelectionMode="Single" SelectedItem="{Binding SelectedBoek, Mode=TwoWay}" VerticalOptions="FillAndExpand">
                        <CollectionView.Header>
                            <Grid ColumnDefinitions="2*,2*,Auto" Padding="8">
                                <Label Text="{Binding HeaderTitle}" Grid.Column="0" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                                <Label Text="{Binding HeaderAuthor}" Grid.Column="1" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                                <Label Text="{Binding HeaderActions}" Grid.Column="2" FontAttributes="Bold" TextColor="{StaticResource Gray900}" HorizontalOptions="End" />
                            </Grid>
                        </CollectionView.Header>

                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Boek">
                                <Grid ColumnDefinitions="2*,2*,Auto" Padding="8" Margin="0,2">
                                    <Label Text="{Binding Titel}" Grid.Column="0" TextColor="{StaticResource Gray900}" LineBreakMode="TailTruncation" MaxLines="1">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnLabelTapped" NumberOfTapsRequired="1" />
                                        </Label.GestureRecognizers>
                                    </Label>

                                    <Label Text="{Binding Auteur}" Grid.Column="1" TextColor="{StaticResource Gray900}" LineBreakMode="TailTruncation" MaxLines="1">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Tapped="OnLabelTapped" NumberOfTapsRequired="1" />
                                        </Label.GestureRecognizers>
                                    </Label>

                                    <!-- Actions stacked vertically -->
                                    <VerticalStackLayout Grid.Column="2" Spacing="6" VerticalOptions="Center" HorizontalOptions="End">
                                        <Button Text="{Binding BindingContext.DetailsButtonText, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                Style="{StaticResource InlineActionButton}"
                                                Command="{Binding BindingContext.ItemDetailsCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}" />

                                        <Button Text="{Binding BindingContext.EditButtonText, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                Style="{StaticResource InlineActionButton}"
                                                Command="{Binding BindingContext.ItemEditCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}" />

                                        <Button Text="{Binding BindingContext.DeleteButtonText, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                Style="{StaticResource InlineDeleteButton}"
                                                Command="{Binding BindingContext.ItemDeleteCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}"
                                                CommandParameter="{Binding .}" />
                                    </VerticalStackLayout>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Paging controls: prev, center page, next -->
                    <Grid HorizontalOptions="Center" Margin="8" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="24">
                        <Button Grid.Column="0" Text="&lt;&lt;" Command="{Binding PrevPageCommand}" Style="{StaticResource PrimaryButton}" WidthRequest="56" HeightRequest="40" />

                        <HorizontalStackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                            <Frame Padding="8,6" HasShadow="False" CornerRadius="10" BackgroundColor="Transparent" HorizontalOptions="Center" VerticalOptions="Center">
                                <Label Text="{Binding PageDisplay}" FontAttributes="Bold" VerticalOptions="Center" HorizontalOptions="Center" TextColor="{StaticResource Gray900}" FontSize="18" />
                            </Frame>
                        </HorizontalStackLayout>

                        <Button Grid.Column="2" Text=">&gt;" Command="{Binding NextPageCommand}" Style="{StaticResource PrimaryButton}" WidthRequest="56" HeightRequest="40" />
                    </Grid>

                    <BoxView HeightRequest="1" Color="{StaticResource Gray200}" />

                    <!-- Edit/add form -->
                    <Border Stroke="{StaticResource Gray100}" StrokeThickness="1" Padding="10">
                        <VerticalStackLayout Spacing="8">
                            <Entry x:Name="TitelEntry" Placeholder="{Binding HeaderTitle}" Text="{Binding Titel, Mode=TwoWay}" />
                            <Entry x:Name="AuteurEntry" Placeholder="{Binding HeaderAuthor}" Text="{Binding Auteur, Mode=TwoWay}" />
                            <Entry x:Name="IsbnEntry" Placeholder="{Binding IsbnPlaceholder}" Text="{Binding Isbn, Mode=TwoWay}" />

                            <Picker x:Name="EditCategoriePicker" Title="{Binding CategoryTitle}" ItemsSource="{Binding Categorien}" ItemDisplayBinding="{Binding Naam}" SelectedItem="{Binding SelectedCategory, Mode=TwoWay}" HorizontalTextAlignment="Start" />

                            <HorizontalStackLayout Spacing="12" HorizontalOptions="End">
                                <Button Text="{Binding NewButtonText}" Command="{Binding NieuwCommand}" Style="{StaticResource OutlineActionButton}" />
                                <Button Text="{Binding DeleteButtonText}" Command="{Binding VerwijderCommand}" BackgroundColor="Crimson" TextColor="White" />
                                <Button Text="{Binding SaveButtonText}" Command="{Binding OpslaanCommand}" Style="{StaticResource PrimaryButton}" />
                            </HorizontalStackLayout>
                        </VerticalStackLayout>
                    </Border>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>