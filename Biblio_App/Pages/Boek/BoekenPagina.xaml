<?xml version="1.0" encoding="utf-8" ?>
<?xaml-comp compile="true" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodel="clr-namespace:Biblio_App.ViewModels"
             xmlns:models="clr-namespace:Biblio_Models.Entiteiten;assembly=Biblio_Models"
             x:Class="Biblio_App.Pages.BoekenPagina"
             x:DataType="viewmodel:BoekenViewModel"
             Title="{Binding PageTitle}"
             x:Name="Page"
             BackgroundColor="White">

    <Shell.TitleView>
        <Grid Padding="0,0,8,0" VerticalOptions="Center">
            <!-- named TitleLabel so code-behind can force-update the displayed title when language changes -->
            <Label x:Name="TitleLabel" Text="{Binding PageTitle}" FontSize="22" FontAttributes="Bold" VerticalOptions="Center" TextColor="{StaticResource White}" />
        </Grid>
    </Shell.TitleView>

    <!-- Use Grid layout so CollectionView receives available space and virtualization works correctly -->
    <Grid Padding="20" RowDefinitions="Auto,Auto,*,Auto">
        <!-- Header / search row -->
        <VerticalStackLayout Grid.Row="0" Spacing="8">
            <HorizontalStackLayout Spacing="8">
                <SearchBar Placeholder="{Binding SearchPlaceholder}" Text="{Binding SearchText}" HorizontalOptions="FillAndExpand"
                           BackgroundColor="White" TextColor="{StaticResource Gray900}" PlaceholderColor="{StaticResource Gray500}" />
                <Button Text="{Binding SearchButtonText}" Command="{Binding ZoekCommand}" />
            </HorizontalStackLayout>
            <HorizontalStackLayout Spacing="8">
                <Picker Title="{Binding CategoryTitle}" ItemsSource="{Binding Categorien}" ItemDisplayBinding="{Binding Naam}" SelectedItem="{Binding SelectedFilterCategorie}" WidthRequest="200" HorizontalTextAlignment="Start"
                        BackgroundColor="White" TextColor="{StaticResource Gray900}" />
            </HorizontalStackLayout>
        </VerticalStackLayout>

        <!-- Spacer -->
        <BoxView Grid.Row="1" HeightRequest="8" BackgroundColor="Transparent" />

        <!-- CollectionView: occupies star-sized row so it can scroll internally -->
        <Frame Grid.Row="2" Style="{StaticResource WelcomeCardStyle}">
            <Grid RowDefinitions="Auto,*,Auto,Auto">
                <CollectionView ItemsSource="{Binding Boeken}" SelectionMode="Single" SelectedItem="{Binding SelectedBoek, Mode=TwoWay}" Grid.Row="1">
                    <CollectionView.Header>
                        <Grid ColumnDefinitions="2*,2*,Auto" ColumnSpacing="16" Padding="8">
                            <Label Text="{Binding HeaderTitle}" Grid.Column="0" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Text="{Binding HeaderAuthor}" Grid.Column="1" FontAttributes="Bold" TextColor="{StaticResource Gray900}" />
                            <Label Text="{Binding CategoryTitle}" Grid.Column="2" FontAttributes="Bold" TextColor="{StaticResource Gray900}" HorizontalOptions="End" />
                        </Grid>
                    </CollectionView.Header>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:Boek">
                            <Grid ColumnDefinitions="2*,2*,Auto" ColumnSpacing="16" Padding="6" Margin="0,2" VerticalOptions="Center">
                                <Label Text="{Binding Titel}" Grid.Column="0" TextColor="{StaticResource Gray900}" LineBreakMode="TailTruncation" MaxLines="1">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnLabelTapped" NumberOfTapsRequired="1" />
                                    </Label.GestureRecognizers>
                                </Label>

                                <Label Text="{Binding Auteur}" Grid.Column="1" TextColor="{StaticResource Gray900}" LineBreakMode="TailTruncation" MaxLines="1">
                                    <Label.GestureRecognizers>
                                        <TapGestureRecognizer Tapped="OnLabelTapped" NumberOfTapsRequired="1" />
                                    </Label.GestureRecognizers>
                                </Label>

                                <!-- Show category name for the book -->
                                <Label Grid.Column="2" Text="{Binding CategorieNaam}" TextColor="{StaticResource Gray900}" VerticalOptions="Center" HorizontalOptions="End" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Paging controls -->
                <Grid Grid.Row="2" HorizontalOptions="Center" Margin="8" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="24">
                    <Button Grid.Column="0" Text="{Binding PrevButtonText}" Command="{Binding PrevPageCommand}" Style="{StaticResource PrimaryButton}" WidthRequest="56" HeightRequest="40" />

                    <HorizontalStackLayout Grid.Column="1" HorizontalOptions="Center" VerticalOptions="Center">
                        <Frame Padding="8,6" HasShadow="False" CornerRadius="10" BackgroundColor="Transparent" HorizontalOptions="Center" VerticalOptions="Center">
                            <Label Text="{Binding PageDisplay}" FontAttributes="Bold" VerticalOptions="Center" HorizontalOptions="Center" TextColor="{StaticResource Gray900}" FontSize="18" />
                        </Frame>
                    </HorizontalStackLayout>

                    <Button Grid.Column="2" Text="{Binding NextButtonText}" Command="{Binding NextPageCommand}" Style="{StaticResource PrimaryButton}" WidthRequest="56" HeightRequest="40" />
                </Grid>

                <BoxView Grid.Row="3" HeightRequest="1" Color="{StaticResource Gray200}" />
            </Grid>
        </Frame>

        <!-- Edit/add form below collection -->
        <VerticalStackLayout Grid.Row="3" Spacing="8">
            <!-- action overview text above the form (moved slightly lower) -->
            <Label Text="{Binding OverviewText}" HorizontalOptions="Fill" HorizontalTextAlignment="Center" TextColor="{StaticResource Primary}"
                   FontAttributes="Bold" FontSize="14" Margin="0,18,0,6" />

            <!-- breadcrumb / action overview text, centered and aligned -->
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="12" Padding="0,0,0,6">
                <Label Text="Overzicht" TextColor="{StaticResource Gray700}" FontAttributes="Bold" />
                <Label Text="-" TextColor="{StaticResource Gray400}" />
                <Label Text="Details" TextColor="{StaticResource Gray700}" />
                <Label Text="-" TextColor="{StaticResource Gray400}" />
                <Label Text="Bewerk" TextColor="{StaticResource Gray700}" />
                <Label Text="-" TextColor="{StaticResource Gray400}" />
                <Label Text="Verwijder" TextColor="{StaticResource Gray700}" />
            </HorizontalStackLayout>

            <Border Stroke="{StaticResource Gray100}" StrokeThickness="1" Padding="10">
                <VerticalStackLayout Spacing="8">
                    <Entry x:Name="TitelEntry" Placeholder="{Binding HeaderTitle}" Text="{Binding Titel, Mode=TwoWay}" BackgroundColor="White" TextColor="{StaticResource Gray900}" PlaceholderColor="{StaticResource Gray500}" />
                    <Entry x:Name="AuteurEntry" Placeholder="{Binding HeaderAuthor}" Text="{Binding Auteur, Mode=TwoWay}" BackgroundColor="White" TextColor="{StaticResource Gray900}" PlaceholderColor="{StaticResource Gray500}" />
                    <Entry x:Name="IsbnEntry" Placeholder="{Binding IsbnPlaceholder}" Text="{Binding Isbn, Mode=TwoWay}" BackgroundColor="White" TextColor="{StaticResource Gray900}" PlaceholderColor="{StaticResource Gray500}" />

                    <Picker x:Name="EditCategoriePicker" Title="{Binding CategoryTitle}" ItemsSource="{Binding Categorien}" ItemDisplayBinding="{Binding Naam}" SelectedItem="{Binding SelectedCategory, Mode=TwoWay}" HorizontalTextAlignment="Start" BackgroundColor="White" TextColor="{StaticResource Gray900}" />

                    <HorizontalStackLayout Spacing="12" HorizontalOptions="End">
                        <Button Text="{Binding NewButtonText}" Command="{Binding NieuwCommand}" Style="{StaticResource OutlineActionButton}" />
                        <!-- Re-added Delete button bound to VerwijderCommand -->
                        <Button Text="{Binding DeleteButtonText}" Command="{Binding VerwijderCommand}" BackgroundColor="Crimson" TextColor="White" />
                        <Button Text="{Binding SaveButtonText}" Command="{Binding OpslaanCommand}" Style="{StaticResource PrimaryButton}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Border>
        </VerticalStackLayout>
    </Grid>
</ContentPage>