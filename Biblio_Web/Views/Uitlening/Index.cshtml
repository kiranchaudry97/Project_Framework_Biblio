@using Microsoft.Extensions.Localization @* Beschikbaar voor meertalig , en injectie en komen vanuit resx bestanden   *@
@inject IStringLocalizer<Biblio_Web.SharedResource> Localizer
@model IEnumerable<Biblio_Models.Entiteiten.Lenen> 
@* Lijst van uiteleningen, return viewmodel*@
@{
    ViewData["Title"] = Localizer["Loans"]; @*  de paginatitel (gelokaliseerd). + ViewData + querystring uitlezen  *@
    var selLidStr = Context.Request.Query["lidId"].FirstOrDefault();
    int? selLid = int.TryParse(selLidStr, out var tmpLid) ? tmpLid : (int?)null;
    var selBoekStr = Context.Request.Query["boekId"].FirstOrDefault();
    int? selBoek = int.TryParse(selBoekStr, out var tmpBoek) ? tmpBoek : (int?)null;

    @* ViewBag-waarden combineren van controller en query string van URL  van filteren   *@

    var currentSearch = ViewBag.Search as string ?? string.Empty;
    var selectedCategory = ViewBag.SelectedCategory as int?;
    var selectedLid = ViewBag.SelectedLid as int? ?? selLid;
    var selectedBoek = ViewBag.SelectedBoek as int? ?? selBoek;
}

@* Titel tonen ( “Loans / Uitleningen / Prêts)  *@

<h1>@ViewData["Title"]</h1>

@* Formulier(input) voor filteren en zoeken(zoekveld) die komen in url + layout + livesearch*@

<form method="get" class="row g-2 mb-2 align-items-end">
    <div class="col-12 col-md-5">
        <label class="form-label visually-hidden">@Localizer["Search"]</label>
        <input id="searchInput" type="search" name="search" value="@currentSearch" class="form-control" placeholder="@Localizer["SearchPlaceholder"]" /> @* meertalig van resx bestanden *@
    </div>


    @* Categorie filter, de controller vult in, toont dropdown met categorieen , selected als dit de actieve filter is *@
    <div class="col-12 col-md-3">
        <label class="form-label visually-hidden">@Localizer["ChooseCategory"]</label>   @* meertalig van resx bestanden *@
        <select name="categoryId" class="form-select">
            <option value="">-- @Localizer["ChooseCategory"] --</option>
            @*Dynamische opties *@
            @if (ViewBag.Categories is IEnumerable<Biblio_Models.Entiteiten.Categorie> cats)
            {
                foreach (var c in cats)
                {
                    if (selectedCategory.HasValue && selectedCategory.Value == c.Id)
                    {
                        <option value="@c.Id" selected>@c.Naam</option>
                    }
                    else
                    {
                        <option value="@c.Id">@c.Naam</option>
                    }
                }
            }
        </select>
    </div>

    <div class="col-12 col-md-4">
        <div class="row g-2">
            <div class="col-6">
                <label class="form-label">@Localizer["Member"]</label>
                @if (ViewBag.Leden is IEnumerable<Biblio_Models.Entiteiten.Lid> leden)
                {
                    @*Lid dropdown*@
                    <select name="lidId" class="form-select">
                       
                        <option value="">@Localizer["AllMembers"]</option>
                        @foreach(var l in leden)
                        {
                            var full = (l.Voornaam + " " + l.AchterNaam).Trim();
                            if (selectedLid.HasValue && selectedLid.Value == l.Id)
                            {
                                <option value="@l.Id" selected>@full</option>
                            }
                            else
                            {
                                <option value="@l.Id">@full</option>
                            }
                        }
                    </select>
                }
                else
                {
                    @*fallback van option geen filter  *@
                    <select class="form-select"><option disabled>@Localizer["NoMembersLoaded"]</option></select>
                }
            </div>
            <div class="col-6">
                <label class="form-label">@Localizer["Book"]</label>
                @if (ViewBag.Boeken is IEnumerable<Biblio_Models.Entiteiten.Boek> boeken)
                {
                    @*Dropdown van boeken, dezelfde voor author en titel dezelfde selectie logica*@
                    <select name="boekId" class="form-select">
                        <option value="">@Localizer["AllBooks"]</option>
                        @foreach(var b in boeken)
                        {
                            var name = (string.IsNullOrWhiteSpace(b.Titel) ? "" : b.Titel) + (string.IsNullOrWhiteSpace(b.Auteur) ? "" : " — " + b.Auteur);
                            if (selectedBoek.HasValue && selectedBoek.Value == b.Id)
                            {
                                <option value="@b.Id" selected>@name</option>
                            }
                            else
                            {
                                <option value="@b.Id">@name</option>
                            }
                        }
                    </select>
                }
                else
                {
                    <select class="form-select"><option disabled>@Localizer["NoBooksLoaded"]</option></select>
                }
            </div>
        </div>
    </div>
    @*Enkel open leningen , filtert op leningen die nog niet zijn ingeleverd*@ 
    <div class="col-auto">
        <div class="form-check me-2">
            <input type="checkbox" name="onlyOpen" class="form-check-input" id="onlyOpen" />
            <label class="form-check-label" for="onlyOpen">@Localizer["OnlyOpen"]</label>
        </div>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary">@Localizer["Filter"]</button> @* form submit knop *@
    </div>
    <div class="col-auto">
        @*Nieuw rol , alleen personeel  kan nieuwe leningen aanmaken*@
        @if (User.IsInRole("Admin") || User.IsInRole("Medewerker"))
        {
            <a class="btn btn-success" asp-action="Create">@Localizer["New"]</a>
        }
    </div>
</form>

<table class="table table-striped">
    <thead>
        <tr>
            @*Kolomen + meertalig vanuit resx*@
            <th>@Localizer["Member"]</th>
            <th>@Localizer["Book"]</th>
            <th>@Localizer["StartDate"]</th>
            <th>@Localizer["DueDate"]</th>
            <th>@Localizer["IngeleverdOp"]</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="loansTbody">
@foreach(var u in Model)
{
    <tr>
        @*Data tonen gegevens van de lid + boek en datum en pas zicht in de cultuur aan *@
        <td>@u.Lid?.Voornaam @u.Lid?.AchterNaam</td>
        <td>@u.Boek?.Titel</td> @*zoals weergave van title en boek*@
                <td>@(u.StartDate.ToString("d"))</td> @*Datum weergave begin datum  *@
        <td>@(u.DueDate.ToString("d"))</td> @*datum weergave van wanneer *@
        @*Returned valut voor wat er word geselecteerd *@
        <td>@(u.ReturnedAt.HasValue ? u.ReturnedAt.Value.ToString("d") : "-")</td> @* Return Datum weergave *@
        <td>
            @*Op details  knoppen op klikken + overzicht kunnen zien met actie knop + delete  *@
            <a class="btn btn-sm btn-info" asp-action="Details" asp-route-id="@u.Id">@Localizer["Details"]</a>
            @if (User.IsInRole("Admin") || User.IsInRole("Medewerker"))
            {
                @if (u.ReturnedAt == null) @*gekozen actie en word teruggestuurd  enkel open leningen *@
                {
                    <a class="btn btn-sm btn-success" asp-action="Return" asp-route-id="@u.Id">@Localizer["Return"]</a> @*Actie knop voor succes + meertalig en gaat terug met correct url   *@
                }
                        <a class="btn btn-sm btn-danger" asp-action="Delete" asp-route-id="@u.Id">@Localizer["Delete"]</a> @*Actie knop voor verwijderen + meertalig en gaat terug met correcte url  *@
                    }
            }
        </td>
    </tr>
}
    </tbody>
</table>

@section Scripts {
    <script>
        (function () {
            @* JavaScript voor live search functionaliteit + api calls*@
            var debounce = function (fn, delay) {
                var t;
                return function () { var args = arguments; clearTimeout(t); t = setTimeout(function () { fn.apply(null, args); }, delay); };
            };
            @*Tabel bijwerken met resultaten van API en updaten en toont resultaten *@
            var updateTable = function (data) {
                var $tb = $('#loansTbody');
                if (!$tb.length) return;
                $tb.empty();
                if (!data || !data.items || data.items.length === 0) {
                    $tb.append('<tr><td colspan="6" class="text-muted">@Localizer["NoResults"]</td></tr>');
                    return;
                }
                data.items.forEach(function (l) {
                    var lid = l.lid ? ((l.lid.voornaam || '') + ' ' + (l.lid.achterNaam || '')) : '';
                    var boek = l.boek ? (l.boek.titel || '') : '';
                    var start = l.startDate ? new Date(l.startDate).toLocaleDateString() : '';
                    var due = l.dueDate ? new Date(l.dueDate).toLocaleDateString() : '';
                    var returned = l.returnedAt ? new Date(l.returnedAt).toLocaleDateString() : '-';
                    var row = '<tr>' +
                        '<td>' + lid + '</td>' +
                        '<td>' + boek + '</td>' +
                        '<td>' + start + '</td>' +
                        '<td>' + due + '</td>' +
                        '<td>' + returned + '</td>' +
                        '<td></td>' +
                        '</tr>';
                    $tb.append(row);
                });
            };

            var doSearch = debounce(function () {
                var q = $('#searchInput').val();
                var url = '/api/uitleningen?page=1&pageSize=50';
                if (q && q.length > 0) url += '&search=' + encodeURIComponent(q);
                $.getJSON(url).done(function (res) {
                    // API returns { items: [...] }
                    updateTable(res);
                }).fail(function () {
                    // ignore failures for live search
                });
            }, 400);

            $(function () {
                $('#searchInput').on('input', doSearch);
            });
        })();
    </script>
}
